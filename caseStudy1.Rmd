---
title: "Statistics in Action - case study 1"
author: "Toxicity assessment of the MON810 maize"
output:
  html_document:
    fig_height: 3
    fig_width: 8
    number_sections: yes
    toc: no
  pdf_document:
    fig_height: 3
    fig_width: 8
    includes:
      before_body: macros.tex
    keep_tex: yes
    number_sections: yes
    toc: no
---
```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr, ggplot2, tidyverse, pwr, equivalence)
```

</br>


# Introduction

The dataset <ttt>dataMON810_2018.csv</ttt> consists of several measurements made during a subchronic toxicity study concerning the MON810 maize.

Biochemical parameters reflecting most physiological functions were measured two times (week 5 and 14), in particular through serum and urine chemistry, and hematology. Organ weights were measured at week 14.

The main objective of this study is to evaluate possible GMO effects on these parameters.

# Single comparison

   1. We consider the variable "CALCIUM".
First we load the data
```{r}
data.study <- read.csv('/Users/Daniel/Documents/Courses X/Statistics in Action/Homework 1/dataMON810_2018.csv') 
#data.study <- read.csv('https://github.com/daniel-wientjens/Stats-in-Action-Homework-1/blob/master/dataMON810_2018.csv')
```
   

a. test if the mean level of calcium for period 2 is the same for males and females.  </br>**Hint:** plot first the data and justify the test(s) to use.

```{r}
#Splitting the dataset into the two periods 
data.study.p1 <- data.study %>% filter(period == 1)
data.study.p2 <- data.study %>% filter(period == 2)

#Splitting the dataset of period 2 into male and female and plotting the result
data.study.p2.m <- data.study.p2 %>% filter(sex == 'M')
data.study.p2.f <- data.study.p2 %>% filter(sex == 'F')

new <- aggregate(data.study.p2$CALCIUM ~ data.study.p2$sex, FUN= "mean") 
colnames(new) <- c('sex', 'calcium')

ggplot()+
  geom_point(data = data.study.p2.m, aes(x=sex, y=CALCIUM, colour = 'blue'), show.legend = F) + 
  geom_point(data = data.study.p2.f, aes(x=sex, y=CALCIUM, colour = 'red'), show.legend = F) +
  geom_point(data = new, aes(x=sex, y=calcium), size=5, alpha=0.5)

boxplot(CALCIUM ~ sex, data = data.study, col = "blue")
```

```{r}
par(mfrow = c(1, 2))
hist(data.study.p2.f$CALCIUM, main='Histogram of calcium for females')
hist(data.study.p2.m$CALCIUM, main='Histogram of calcium for male')
```
```{r}
aggregate(data.study.p2$CALCIUM ~ data.study.p2$sex, FUN= "sd" )
aggregate(data.study.p2$CALCIUM ~ data.study.p2$sex, FUN= "mean" )
```
After all these plot we have to determine what kind of a distribution we have in front of us. If it is a normal distribution we should use a t-test.
So first we check whether the variances differ between the male and female polulation by performing an F-test. 
Only then we conduct a t-test since we need to know whether to leave the var.equal at it's default value or to change it to TRUE. 
```{r}
alpha<-0.05

x <- data.study[data.study$sex=="M","CALCIUM"]
y <- data.study[data.study$sex=="F","CALCIUM"]
var.test(x,y, alternative = 'two.sided')

t.test(x,y, conf.level=1-alpha, var.equal = FALSE)
```
As we can see the F-test has pointed out that the variances are different. This is then used in the 
Since the p-value is very small, we can reject the H0 and say that the means of the control males and females is different.
If we decide that the distribution of the data is not following a normal distribution we should use a Wilcoxon test.
A Wilcoxon test since it is more powerfull due to lack of assumptions about the distribution of the data. 
```{r}
#add the wilcox test since we do not assume anything with it, when we do the t-test we assume the distribution
m <- data.study %>% filter(sex == 'M', period == 2) %>% dplyr::select(CALCIUM) %>% na.omit()
f <- data.study %>% filter(sex == 'F', period == 2) %>% dplyr::select(CALCIUM) %>% na.omit()
x <- wilcox.test(m[,1], f[,1], alternative = 'two.sided', conf.level=1-0.05)
x
```
Also with this test we see that the p value is very small and hence the H0 can be rejected and that means that the means of the control males and females is different.
So both tests show that the means of calcium levels for males and females in period 2 are the different (since H0 is that they are the same/similar and due to the low p-value we reject H0).

     b. Test for the males if the mean level of calcium is the same for period 1 and period 2.
Here we split the original dataset into the males for period 1 and period 2 and keep only the calcium column in order to do our t-test. Then we perform the F-test and t-test like before plus we also do the Wilcox test.
```{r}
x <- data.study %>% filter(sex == 'M', period == '1') %>% dplyr::select('CALCIUM', 'sex')
y <- data.study %>% filter(sex == 'M', period == '2') %>% dplyr::select('CALCIUM', 'sex')

aggregate(x$CALCIUM ~ x$sex, FUN= "sd" )
aggregate(y$CALCIUM ~ y$sex, FUN= "sd" )

var.test(x$CALCIUM,y$CALCIUM, alternative = 'two.sided')
```
As can be seen in the result above the F-test shows us that the variances are different hence we run the t-test with var.equal = FALSE.
```{r}
t.test(x$CALCIUM,y$CALCIUM, conf.level = 1-alpha, var.equal = FALSE)
```
Since the p-value of the Welch Two Sample t-test is very small, we can reject the H0 and say that the means of the control males in period 1 and period 2 is different.
Next we perform the Wilcoxon test again, since it has less ridged assumptions than the t-test we prefer this test.
(The t-test assumes that the distribution of the data is normal, whereas with the wilcoxon we donâ€™t make the assumption that the distribution of the data belongs to a family of parametric ditributions)
```{r}
m <- data.study %>% filter(sex == 'M', period == 1) %>% dplyr::select(CALCIUM) %>% na.omit()
f <- data.study %>% filter(sex == 'M', period == 2) %>% dplyr::select(CALCIUM) %>% na.omit()
x <- wilcox.test(m[,1], f[,1], alternative = 'two.sided', conf.level=1-0.05)
x
```
Here we can agian see and confirm that the p value is close to 0 and hence reject the H0 and say that the means of the control males in period 1 and period 2 is different.

     c. test for the males if the mean level of calcium for period 2 is the same for the control group and the MON810 group.
As per usual we split the dataset into the two groups we want to compare, so here we filter them to only contain males from period 2 and have the control group vs the MON810 group.
Next we perform a F-test to see whether the variances differ between the two groups and use the result for our final t-test.
```{r}
data.study.cont <- data.study %>% filter(sex == 'M', period == '2', regimen == 'control')
data.study.MON810 <- data.study %>% filter(sex == 'M',period == '2', regimen == 'MON810') 
var.test(data.study.cont$CALCIUM, data.study.MON810$CALCIUM,conf.level = 1-alpha)
t.test(data.study.cont$CALCIUM, data.study.MON810$CALCIUM, conf.level = 1-alpha, var.equal = FALSE)
```
Here we first see that the F-test tells us that the variances are different between the two groups due to the low p-value (0.037) with an alpha of 5%. 
As we can see the p-value of the Welch Two Sample t-test is very high (0.446), so we do not reject the H0 there. This translates into the fact that the means of the males in period 2 of the control and MON810 group do not differ significantly.
Let's perform a Wilcoxon test as well and see if it concurs with the findings of the t-test
```{r}
m <- data.study %>% filter(sex == 'M', period == 2,regimen == 'control') %>% dplyr::select(CALCIUM) %>% na.omit()
f <- data.study %>% filter(sex == 'M', period == 2,regimen == 'MON810') %>% dplyr::select(CALCIUM) %>% na.omit()
x <- wilcox.test(m[,1], f[,1], alternative = 'two.sided', conf.level=1-0.05)
x
```
Here we get a different p-value than the t-test but both of the p-values signify that we cannot reject the H0 and so the two means of the control and MON810 groups do not differ.

    d. What is the probability to detect a difference of 1 sd (one standard deviation) with only 10 animals per group? with 20 animal? How can we ensure to detect such difference with a probability of 80%?
So the two groups are comprised of 10 individuals each, so the number of degrees of freedom is 10+10-2=18
Next for the power of the test should increase by the sample size, but the dt stays the same since delta is the standard deviation and we are dividing the delta by the standard deviation so the result will always be 1
```{r}
alpha=0.05
delta <- 1
x.sd <- 1
df <- 18
dt <- delta/x.sd/sqrt(1/10+1/10)
1-pt(qt(1-alpha/2,df)-dt,df) + pt(qt(alpha/2,df)-dt,df)
```
We can check this by running the code in the function pwr.t.test
```{r}
pwr.t.test(n=10, d=1, type="two.sample", alternative="two.sided", sig.level=alpha)[[4]]
```
So the probability of detecting 1 sd difference with only 10 animals per group is 55%

Next we try the same but change the sample size to 20 animals per group
```{r}
alpha=0.05
delta <- 1 
x.sd <- 1
df <- 38
dt <- delta/x.sd/sqrt(1/20+1/20)
1-pt(qt(1-alpha/2,df)-dt,df) + pt(qt(alpha/2,df)-dt,df)
```
We can check this by running the code in the function pwr.t.test.
```{r}
pwr.t.test(n=20, d=1, type="two.sample", alternative="two.sided", sig.level=alpha)[[4]]
```
So the probability of detecting 1 sd difference with only 20 animals per group is 55%



Next we want to find the number of observations for which the detection of more than 1 sd is equal or higher than 80%.
For this we fill in the power function and set 
```{r}
pwr.t.test(power=0.8, d=dt, sig.level=alpha) 
```
So we have to set n=17 for the probability to be able to detect a difference of 1 standard deviation to be higher than 80%.

     e. Test for the males if the mean levels of calcium for period 2 of the control group and the MON810 are equivalent. The equivalence limits will be defined using the 6 reference groups as 
First we filter the data
```{r}
data.study.cont <- data.study %>% filter(sex == 'M', period == '2', regimen == 'control')
data.study.MON810 <- data.study %>% filter(sex == 'M',period == '2', regimen == 'MON810') 
data.study.ref <- data.study %>% filter(sex == 'M',period == '2', regimen != 'control', regimen != 'MON810') %>%  dplyr::select(regimen, CALCIUM) %>% na.omit
```

     *i)* one standard deviation of the 6 reference means. 
Next we calculate the standard deviation of the 6 reference means
```{r}
ref <- aggregate(data.study.ref$CALCIUM ~ data.study.ref$regimen, FUN = 'mean')
sd(ref$`data.study.ref$CALCIUM`)
```
This value we use in the pt function.
We calculate the degrees of freedom by taking the number of observations and subtracting the number of classes/categories: 58-6=52

```{r}
delta <- sd(ref$`data.study.ref$CALCIUM`)
tost(data.study.MON810$CALCIUM, data.study.cont$CALCIUM, alpha=0.05, epsilon=delta)
```
So the null hypothesis is not rejected, hence the male means of the calcium levels in period two are the same when we take the equivalence limit of 1 sd of the reference means 

```{r}
pt(q = -sd(ref$`data.study.ref$CALCIUM`), df = dim(data.study.ref)[1]-6)*2*100
```
This result says that we have a probabilty of 43% of observing 1 stdev (calculated by the the 6 reference means) given all observations. 
     
     *ii)* two standard deviations of the 6 reference means.
```{r}
delta <- 2* sd(ref$`data.study.ref$CALCIUM`)
tost(data.study.MON810$CALCIUM, data.study.cont$CALCIUM, alpha=0.05, epsilon=delta)
```
Now the only difference is that we multiply the delta by 2 since we want to take two sd.

```{r}
pt(q = -2*sd(ref$`data.study.ref$CALCIUM`), df = dim(data.study.ref)[1]-6)*2*100
```
This result says that we have a probabilty of 12% of observing 2 stdev (calculated by the the 6 reference means) given all observations.      
     
     f. Summarize and comment these results.
   
   2. Do the same analysis with the variable "DIRBILI" (direct bilirubin)

a)test if the mean level of calcium for period 2 is the same for males and females. 
Hint: plot first the data and justify the test(s) to use.

   Here we unfortunately cannot do the same test as before since DIRBILI is discreet data in period 2.
   Nevertheless we plot the data and see what we can learn from it.

```{r}
dirbili <- data.study %>% dplyr::select(regimen,sex,period,DIRBILI) %>% na.omit()
dirbili$period <- as.factor(dirbili$period)
```

```{r}
#Splitting the dataset into the two periods 
dirbili.p1 <- dirbili %>% filter(period == 1)
dirbili.p2 <- dirbili %>% filter(period == 2)

#Splitting the dataset into period 1 and 2 and into male and female and plotting the result
dirbili.p2.m <- dirbili.p2 %>% filter(sex == 'M')
dirbili.p2.f <- dirbili.p2 %>% filter(sex == 'F')

dirbili.p1.m <- dirbili.p1 %>% filter(sex == 'M')
dirbili.p1.f <- dirbili.p1 %>% filter(sex == 'F')

new <- aggregate(dirbili$DIRBILI ~ dirbili$sex, FUN= "mean") 
colnames(new) <- c('sex', 'dirbili')

ggplot() +
  geom_point(data = dirbili.p2.m, aes(x=sex, y=DIRBILI, colour = 'blue'), show.legend = F) + 
  geom_point(data = dirbili.p2.f, aes(x=sex, y=DIRBILI, colour = 'red'), show.legend = F) +
  geom_point(data = new, aes(x=sex, y=dirbili), size=5, alpha=0.5)
```

```{r}
table(dirbili.p2 %>% dplyr::select(sex,DIRBILI))
```
Since this is categorical data and hence split into different classes we perform a chi squared test on the continuity table.
```{r}
chisq.test(table(dirbili.p2 %>% dplyr::select(sex,DIRBILI)), correct = FALSE)
```
As we can see the p value is large and hence the H0 holds where we say that the means of the two groups male and female in period two do not differ.

b)test for the males if the mean level of dirbili is the same for period 1 and period 2.
```{r}
new <- aggregate(dirbili$DIRBILI ~ dirbili$period, FUN= "mean") 
colnames(new) <- c('period', 'dirbili')

ggplot() +
  geom_point(data = dirbili.p1.m, aes(x=period, y=DIRBILI, colour = period), show.legend = F) + 
  geom_point(data = dirbili.p2.m, aes(x=period, y=DIRBILI, colour = period), show.legend = F) +
  geom_point(data = new, aes(x=period, y=dirbili), size=5, alpha=0.5)
```


```{r}
table(dirbili %>% dplyr::select(period,DIRBILI))
```
Since correction is only available for 2 by 2 tables we do not need to write it in the formula

```{r}
chisq.test(table(dirbili %>% dplyr::select(period,DIRBILI)))
```
So we can reject the H0 hence we can say that the two means are different.


c)test for the males if the mean level of calcium for period 2 is the same for the control group and the MON810 group.
```{r}
dirbili.cont <- dirbili %>% filter(sex == 'M', period == '2', regimen == 'control')
dirbili.MON810 <- dirbili %>% filter(sex == 'M',period == '2', regimen == 'MON810') 
```

```{r}
new <- aggregate(dirbili.p2.m$DIRBILI ~ dirbili.p2.m$regimen, FUN= "mean")
colnames(new) <- c('regimen', 'dirbili')
new <- new %>% filter(regimen %in% c('control','MON810')) 

unique(dirbili.p2.m)

ggplot() +
  geom_point(data = dirbili.p2.m %>% filter(regimen == 'control'), aes(x=regimen, y=DIRBILI, colour = regimen), show.legend = F) + 
  geom_point(data = dirbili.p2.m %>% filter(regimen == 'MON810'), aes(x=regimen, y=DIRBILI, colour = regimen), show.legend = F) +
  geom_point(data = new, aes(x=regimen, y=dirbili), size=5, alpha=0.5)
```
As we can see here the two means are the same so we perform another chisquared test
```{r}
table(dirbili.p2.m  %>% filter(regimen %in% c('control','MON810')) %>% dplyr::select(regimen, DIRBILI))[1:2,]
```

```{r}
chisq.test(table(dirbili.p2.m  %>% filter(regimen %in% c('control','MON810')) %>% dplyr::select(regimen, DIRBILI))[1:2,])
```
Here the p-value is equal to 1 which makes sense since the means are the same and we have the same number of observations per dirbili group. 

d) What is the probability to detect a difference of 1 sd (one standard deviation) with only 10 animals per group? with 20 animal? How can we ensure to detect such difference with a probability of 80%?

```{r}

```


e) Test for the males if the mean levels of dirbili for period 2 of the control group and the MON810 are equivalent. The equivalence limits will be defined using the 6 reference groups as i) one standard deviation of the 6 reference means, ii) two standard deviations of the 6 reference means.

First we filter the data
```{r}
data.study.cont <- data.study %>% filter(sex == 'M', period == '2', regimen == 'control')
data.study.MON810 <- data.study %>% filter(sex == 'M',period == '2', regimen == 'MON810') 
data.study.ref <- data.study %>% filter(sex == 'M',period == '2', regimen != 'control', regimen != 'MON810') %>%  dplyr::select(regimen, DIRBILI) %>% na.omit
```

     *i)* one standard deviation of the 6 reference means. 
Next we calculate the standard deviation of the 6 reference means
```{r}
ref <- aggregate(data.study.ref$DIRBILI ~ data.study.ref$regimen, FUN = 'mean')
sd(ref$`data.study.ref$DIRBILI`)
```

```{r}
delta <- sd(ref$`data.study.ref$DIRBILI`)
tost(data.study.MON810$DIRBILI, data.study.cont$DIRBILI, alpha=0.05, epsilon=delta)
```
So the null hypothesis is not rejected, hence the male means of the DIRBILI levels in period two are the same when we take the equivalence limit of 1 sd of the reference means.

This value we use in the pt function.
We calculate the degrees of freedom by taking the number of observations and subtracting the number of classes/categories: 60-6=54
```{r}
pt(q = -sd(ref$`data.study.ref$DIRBILI`), df = dim(data.study.ref)[1]-6)*2*100
```
This result says that we have a probabilty of 99% of observing 1 stdev (calculated by the the 6 reference means) given all observations. 
     
     *ii)* two standard deviations of the 6 reference means.
```{r}
delta <- 2* sd(ref$`data.study.ref$DIRBILI`)
tost(data.study.MON810$DIRBILI, data.study.cont$DIRBILI, alpha=0.05, epsilon=delta)
```
Now the only difference is that we multiply the delta by 2 since we want to take two sd.

```{r}
pt(q = -2*sd(ref$`data.study.ref$DIRBILI`), df = dim(data.study.ref)[1]-6)*2*100
```
This result says that we have a probabilty of 98% of observing 2 stdev (calculated by the the 6 reference means) given all observations. 



</br>


# Multiple comparisons


   1. Redo the three tests of the previous section (questions a., b. and c.) for now comparing  the means of all the quantitative variables (see the annex 5 of the ANSES report <ttt>BIOT2009sa0285Ra.pdf</ttt> to know the type of each variable). Store the results (i.e. all the p-values) in a dataframe with one variable per row and four columns (name of the variable + three p-values). 
   All the variables are quantitative except these: BILI, PROT, GLUCOSE, BLOOD, KETONE, UROBILI, GAMMAGT, TESTIS

First we make the functions per question using the Wilcoxon test
```{r}
question.a_wilcox <- function(variable){
  m <- data.study %>% filter(sex == 'M', period == 2) %>% dplyr::select(variable) %>% na.omit()
  f <- data.study %>% filter(sex == 'F', period == 2) %>% dplyr::select(variable) %>% na.omit()
  if (dim(m)[1] > 0 && dim(f)[1]>0){
    x <- wilcox.test(m[,1], f[,1], alternative = 'two.sided', conf.level=1-0.05)
    return(x$p.value)
  }
  else{
    return(NA)
    }
}
question.a_wilcox('CALCIUM')
```

```{r}
question.b_wilcox <- function(variable){
  m <- data.study %>% filter(sex == 'M', period == 1) %>% dplyr::select(variable) %>% na.omit()
  f <- data.study %>% filter(sex == 'M', period == 2) %>% dplyr::select(variable) %>% na.omit()
  if(dim(m)[1] > 0 && dim(f)[1] > 0){
    x <- wilcox.test(m[,1], f[,1], alternative = 'two.sided', conf.level=1-0.05)
    return(x$p.value)
  }
  else{
    return(NA)
  }
}
question.b_wilcox('CALCIUM')
```

```{r}
question.c_wilcox <- function(variable){
  m <- data.study %>% filter(sex == 'M', period == 2,regimen == 'control') %>% dplyr::select(variable) %>% na.omit()
  f <- data.study %>% filter(sex == 'M', period == 2,regimen == 'MON810') %>% dplyr::select(variable) %>% na.omit()
  if(dim(m)[1] > 0 && dim(f)[1] > 0){  
  x <- wilcox.test(m[,1], f[,1], alternative = 'two.sided', conf.level=1-0.05)
    return(x$p.value)
  }
  else{
    return(NA)
  }  
}
question.c_wilcox('CALCIUM')
```

Now we make all the functions for the same questions using the t-test
```{r}
question.a_ttest <- function(variable){
  alpha<-0.05
  m <- data.study %>% filter(period == 2, sex=='M') %>% dplyr::select(sex, variable) %>% na.omit
  f <- data.study %>% filter(period == 2, sex=='F') %>% dplyr::select(sex, variable) %>% na.omit
  if(dim(m)[1] > 0 && dim(f)[1] > 0){
    fval <- var.test(m[,2],f[,2], alternative = 'two.sided')$p.val >0.05
    y <- t.test(m[,2],f[,2], conf.level=1-alpha, var.equal = fval)
    return(y$p.value)
  }
  else{
    return(NA)
  } 
}
question.a_ttest('CALCIUM')
```

```{r}
question.b_ttest <- function(variable){
  x <- data.study %>% filter(sex == 'M', period == '1') %>% dplyr::select(sex, variable)
  y <- data.study %>% filter(sex == 'M', period == '2') %>% dplyr::select(sex, variable)
  if(dim(x)[1] > 0 && dim(y)[1] > 0){
    fval<-var.test(x$CALCIUM,y$CALCIUM, alternative = 'two.sided')$p.val > 0.05
    m <- t.test(x$CALCIUM,y$CALCIUM, conf.level = 1-alpha, var.equal = fval)
    return(m$p.value)
  }
  else{
    return(NA)
  }
}
question.b_ttest('CALCIUM')
```

```{r}
question.c_ttest <- function(variable){
  c <- data.study %>% filter(sex == 'M', period == '2', regimen == 'control')
  m <- data.study %>% filter(sex == 'M',period == '2', regimen == 'MON810') 
  if(dim(c)[1] > 0 && dim(m)[1] > 0){
    fval <- var.test(data.study.cont$CALCIUM, data.study.MON810$CALCIUM,conf.level = 1-alpha)$p.val >0.05
    r <- t.test(c$CALCIUM, m$CALCIUM, conf.level = 1-alpha, var.equal = FALSE)
    return(r$p.value)
  }
  else{
    return(NA)
  }
}
question.c_ttest('CALCIUM')
```

Next we apply these functions to all the other quantitative variables in the table and save the results in a dataframe.
First we have to make the list of all the column names we want to loop over and use as input for our functions.
```{r}
variable <- data.study  %>% dplyr::select(-GLUCOSE, -BLOOD, -BILI, -PROT ,-KETONE, -UROBILI, -GAMMAGT, -TESTIS,-id,-X,-regimen,-sex,-period) %>% colnames()
```


```{r}
wilcox <- data.frame()
ttest <- data.frame()
for (i in 1:length(variable)){
  # Wilcox results
  wilcox <- rbind(wilcox, cbind(variable[i], question.a_wilcox(variable[i]), question.b_wilcox(variable[i]), question.c_wilcox(variable[i])))
  # t-test results
  ttest <- rbind(ttest, cbind(variable[i], question.a_ttest(variable[i]), question.b_ttest(variable[i]), question.c_ttest(variable[i])))
}

colnames(wilcox) <- c('variable', 'a', 'b', 'c')
colnames(ttest) <- c('variable', 'a', 'b', 'c')
```


```{r}
for (i in 1:10){
  print(question.a(variable[i,]))
}

for (i in 1:10){
  print(questionB(variable[i,]))
}

for (i in 1:10){
  print(getp3(variable[i,]))
}


result <- apply (variable, 1, function(x) question.a(x))

```

   
   
   2. For each of the three tests, adjust the p-values using the Bonferroni  and the Benjamini-Hochberg corrections. How can we interpret these results?
   


